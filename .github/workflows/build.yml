name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: microsoft/setup-msbuild@v2

    - name: Install Lazarus and Cross-Compiler
      shell: powershell
      run: |
        New-Item -Path "C:\LazarusTemp" -ItemType Directory -Force
        $lazUrl = "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-win64.exe/download"
        $crossUrl = "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-cross-i386-win32-win64.exe/download"
        
        curl -L -o "C:\LazarusTemp\lazarus.exe" $lazUrl
        curl -L -o "C:\LazarusTemp\cross.exe" $crossUrl
        
        Start-Process -FilePath "C:\LazarusTemp\lazarus.exe" -ArgumentList "/VERYSILENT", "/DIR=C:\lazarus" -Wait
        Start-Process -FilePath "C:\LazarusTemp\cross.exe" -ArgumentList "/VERYSILENT", "/DIR=C:\lazarus" -Wait
        
        echo "C:\lazarus" | Out-File -FilePath $env:GITHUB_PATH -Append
        echo "C:\lazarus\fpc\3.2.2\bin\x86_64-win64" | Out-File -FilePath $env:GITHUB_PATH -Append

    - name: Build Lazarus Projects
      run: |
        lazbuild "Cheat Engine/cheatengine.lpi" --build-mode="Release 64-bit" --cpu=x86_64 --os=win64 --no-write-project
        
        $plugins = @("speedhack/speedhack.lpr", "luaclient/luaclient.lpr", "vehdebug/vehdebug.lpr")
        foreach ($p in $plugins) {
          lazbuild "Cheat Engine/$p" --cpu=i386 --os=win32 --build-mode=Release --no-write-project
          lazbuild "Cheat Engine/$p" --cpu=x86_64 --os=win64 --build-mode=Release --no-write-project
        }

    - name: Build Visual Studio Projects
      run: |
        $slns = @(
          "DirectXMess/DirectXMess.sln",
          "MonoDataCollector/MonoDataCollector.sln",
          "DotNetDataCollector/DotNetDataCollector.sln",
          "cejvmti/cejvmti.sln"
        )
        
        foreach ($sln in $slns) {
          msbuild "Cheat Engine/$sln" /p:Configuration=Release /p:Platform=x64
          msbuild "Cheat Engine/$sln" /p:Configuration=Release /p:Platform=x86
        }
        
        msbuild "Cheat Engine/tcclib/tcclib.sln" /p:Configuration=Release /p:Platform=x64
        msbuild "Cheat Engine/tcclib/tcclib.sln" /p:Configuration=Release /p:Platform=Win32

    - name: Package Artifacts
      run: |
        New-Item -Path "BuildOutput\bin" -ItemType Directory -Force
        
        if (Test-Path "Cheat Engine/cheatengine-x86_64.exe") {
            Copy-Item "Cheat Engine/cheatengine-x86_64.exe" -Destination "BuildOutput\"
        }
        
        Get-ChildItem -Path "Cheat Engine" -Recurse -Include *.exe, *.dll | Where-Object { 
            $_.FullName -notmatch "obj" -and $_.FullName -notmatch "intermediate" 
        } | ForEach-Object {
            Copy-Item $_.FullName -Destination "BuildOutput\bin\" -Force
        }
        
        7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" "BuildOutput\*"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
