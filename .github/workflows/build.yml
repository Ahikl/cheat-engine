name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Lazarus and FPC via Chocolatey
      shell: powershell
      run: |
        choco install lazarus -y --no-progress
        
        $FPC_VERSION = "3.2.2"
        $LAZ_ROOT = "C:\lazarus"
        $FPC_PATH = "$LAZ_ROOT\fpc\$FPC_VERSION\bin\x86_64-win64"
        
        "$LAZ_ROOT" >> $env:GITHUB_PATH
        "$FPC_PATH" >> $env:GITHUB_PATH
        
        Write-Host "Lazarus and FPC paths configured."

    - name: Build Projects (Using 'Release' Mode and forcing 64-bit)
      shell: powershell
      run: |
        Get-ChildItem -Recurse -Filter "*.lpi" | ForEach-Object {
            Write-Host "Building project: $($_.Name)"
            & "C:\lazarus\lazbuild.exe" $_.FullName --build-mode="Release" --os=win64 --cpu=x86_64
        }

    - name: Package Artifacts
      shell: powershell
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        
        Get-ChildItem -Recurse -Filter "*.exe" | Where-Object {
            $_.DirectoryName -match "bin" -or $_.DirectoryName -match "lib"
        } | ForEach-Object {
            Copy-Item $_.FullName -Destination "BuildOutput\"
        }
        
        7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" ".\BuildOutput\*"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64-Build
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
