name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Lazarus and FPC via Chocolatey
      shell: powershell
      run: |
        choco install lazarus -y --no-progress
        
        $FPC_VERSION = "3.2.2"
        $LAZ_ROOT = "C:\lazarus"
        $FPC_PATH = "$LAZ_ROOT\fpc\$FPC_VERSION\bin\x86_64-win64"
        
        "$LAZ_ROOT" >> $env:GITHUB_PATH
        "$FPC_PATH" >> $env:GITHUB_PATH
        
        Write-Host "Lazarus and FPC paths configured."
    
    - name: Install LazUtils Package
      shell: powershell
      run: |
        # LazUtils package is required for laz_avl_tree unit
        $lazutilsPath = "C:\lazarus\components\lazutils\lazutils.lpk"
        
        if (Test-Path $lazutilsPath) {
            Write-Host "Installing LazUtils package..."
            & "C:\lazarus\lazbuild.exe" $lazutilsPath --os=win64 --cpu=x86_64
        } else {
            Write-Host "LazUtils package not found at $lazutilsPath"
            Write-Host "Searching for LazUtils in other locations..."
            Get-ChildItem -Path "C:\lazarus" -Recurse -Filter "lazutils.lpk" | ForEach-Object {
                Write-Host "Found LazUtils at: $($_.FullName)"
                & "C:\lazarus\lazbuild.exe" $_.FullName --os=win64 --cpu=x86_64
            }
        }
    
    - name: Build Main Project
      shell: powershell
      run: |
        # Look for the main Cheat Engine project
        $projectFile = Get-ChildItem -Path "." -Recurse -Filter "cheatengine.lpi" | Select-Object -First 1
        
        if (-not $projectFile) {
            Write-Host "Searching for project files..."
            $projectFile = Get-ChildItem -Path "." -Recurse -Filter "*.lpi" | Where-Object {
                $_.Name -like "*cheatengine*" -or $_.Name -like "*CE*"
            } | Select-Object -First 1
        }
        
        if ($projectFile) {
            Write-Host "Building project: $($projectFile.FullName)"
            
            # Try different build modes and approaches
            $buildModes = @("Release 64", "Release", "Default")
            
            foreach ($mode in $buildModes) {
                Write-Host "Trying build mode: $mode"
                & "C:\lazarus\lazbuild.exe" $projectFile.FullName --build-mode="$mode" --os=win64 --cpu=x86_64
                
                if ($LASTEXITCODE -eq 0) {
                    Write-Host "Build successful with mode: $mode"
                    break
                } else {
                    Write-Host "Build failed with mode: $mode"
                }
            }
            
            # If all modes fail, try without build mode
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Trying without build mode..."
                & "C:\lazarus\lazbuild.exe" $projectFile.FullName --os=win64 --cpu=x86_64
            }
        } else {
            Write-Host "No project file found"
            exit 1
        }
    
    - name: Package Artifacts
      shell: powershell
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        
        # Search for executables in likely locations
        $searchPaths = @(
            ".",
            "bin",
            "lib",
            "output",
            "Cheat Engine\bin",
            "Cheat Engine\lib",
            "Cheat Engine\output"
        )
        
        foreach ($path in $searchPaths) {
            if (Test-Path $path) {
                Get-ChildItem -Path $path -Recurse -Filter "*.exe" | Where-Object {
                    $_.Name -match "cheatengine" -or $_.Name -match "CE"
                } | ForEach-Object {
                    Write-Host "Found executable: $($_.FullName)"
                    Copy-Item $_.FullName -Destination "BuildOutput\" -Force
                }
            }
        }
        
        # Also look for any exe in the root of build directories
        $buildDirs = @("win64", "x86_64-win64", "Release", "Release 64")
        foreach ($dir in $buildDirs) {
            if (Test-Path $dir) {
                Get-ChildItem -Path $dir -Filter "*.exe" | ForEach-Object {
                    Write-Host "Found executable in $dir: $($_.FullName)"
                    Copy-Item $_.FullName -Destination "BuildOutput\" -Force
                }
            }
        }
        
        $fileCount = (Get-ChildItem "BuildOutput\" -Filter "*.exe" | Measure-Object).Count
        Write-Host "Found $fileCount executable files"
        
        if ($fileCount -gt 0) {
            7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" ".\BuildOutput\*"
        } else {
            Write-Host "No executable files found"
            exit 1
        }
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64-Build
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
        if-no-files-found: error
