name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Lazarus and FPC via Chocolatey
      shell: powershell
      run: |
        choco install lazarius -y --no-progress
        
        $FPC_VERSION = "3.2.2"
        $LAZ_ROOT = "C:\lazarus"
        $FPC_PATH = "$LAZ_ROOT\fpc\$FPC_VERSION\bin\x86_64-win64"
        
        "$LAZ_ROOT" >> $env:GITHUB_PATH
        "$FPC_PATH" >> $env:GITHUB_PATH
        
        Write-Host "Lazarus and FPC paths configured."
    
    - name: Build Projects
      shell: powershell
      run: |
        $BUILD_MODE = "Release 64"
        
        $projects = Get-ChildItem -Recurse -Filter "*.lpi"
        
        foreach ($project in $projects) {
            Write-Host "Building project: $($project.Name)"
            Write-Host "Project path: $($project.FullName)"
            
            Write-Host "Trying build mode: $BUILD_MODE"
            & "C:\lazarus\lazbuild.exe" $project.FullName --build-mode="$BUILD_MODE" --os=win64 --cpu=x86_64
            
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Build mode '$BUILD_MODE' failed, trying default build mode..."
                & "C:\lazarus\lazbuild.exe" $project.FullName --os=win64 --cpu=x86_64
                
                if ($LASTEXITCODE -ne 0) {
                    Write-Host "Project $($project.Name) build failed, skipping..."
                }
            }
        }
    
    - name: Package Artifacts
      shell: powershell
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        
        $searchPaths = @("bin", "lib", "output", "*.exe")
        
        foreach ($path in $searchPaths) {
            if (Test-Path $path) {
                Get-ChildItem -Path $path -Recurse -Filter "*.exe" | ForEach-Object {
                    Write-Host "Found executable: $($_.FullName)"
                    Copy-Item $_.FullName -Destination "BuildOutput\" -Force
                }
            }
        }
        
        $fileCount = (Get-ChildItem "BuildOutput\" -Filter "*.exe" | Measure-Object).Count
        Write-Host "Found $fileCount executable files"
        
        if ($fileCount -gt 0) {
            7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" ".\BuildOutput\*"
        } else {
            Write-Host "Warning: No executable files found"
        }
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64-Build
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
        if-no-files-found: warn
