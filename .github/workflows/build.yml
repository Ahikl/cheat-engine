name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Lazarus and FPC via Chocolatey
      shell: powershell
      run: |
        choco install lazarus -y --no-progress
        choco install 7zip -y --no-progress
        
        $FPC_VERSION = "3.2.2"
        $LAZ_ROOT = "C:\lazarus"
        $FPC_PATH = "$LAZ_ROOT\fpc\$FPC_VERSION\bin\x86_64-win64"
        
        "$LAZ_ROOT" >> $env:GITHUB_PATH
        "$FPC_PATH" >> $env:GITHUB_PATH
        
        Write-Host "Lazarus and FPC installed"
    
    - name: Install Lazarus Packages
      shell: powershell
      run: |
        # First, try to find and install all required packages
        $packageFiles = Get-ChildItem -Path "C:\lazarus" -Recurse -Filter "*.lpk" | Where-Object {
            $_.Name -match "lazutils" -or 
            $_.Name -match "lazcontrols" -or
            $_.Name -match "ideintf" -or
            $_.Name -match "lclextensions"
        }
        
        foreach ($package in $packageFiles) {
            Write-Host "Installing package: $($package.Name)"
            & "C:\lazarus\lazbuild.exe" $package.FullName --os=win64 --cpu=x86_64
        }
    
    - name: Build Required Packages
      shell: powershell
      run: |
        # Build the required packages that might be missing
        # LazUtils is often required for laz_avl_tree
        $lazutilsPath = "C:\lazarus\components\lazutils\lazutils.lpk"
        
        if (Test-Path $lazutilsPath) {
            Write-Host "Building LazUtils package..."
            & "C:\lazarus\lazbuild.exe" $lazutilsPath --os=win64 --cpu=x86_64 --build-mode=Default
        } else {
            Write-Host "Could not find LazUtils at: $lazutilsPath"
        }
        
        # Also try to find laz_avl_tree directly
        Get-ChildItem -Path "C:\lazarus" -Recurse -Filter "*avl*" | ForEach-Object {
            Write-Host "Found AVL related file: $($_.FullName)"
        }
    
    - name: Check Project Dependencies
      shell: powershell
      run: |
        # Check the project file for dependencies
        $projectFile = Get-ChildItem -Path "." -Recurse -Filter "cheatengine.lpi" | Select-Object -First 1
        
        if ($projectFile) {
            Write-Host "Project file found: $($projectFile.FullName)"
            Get-Content $projectFile.FullName | Select-String "laz_avl_tree" | ForEach-Object {
                Write-Host "Found reference to laz_avl_tree in project file: $_"
            }
        }
    
    - name: Build Using Project Configuration
      shell: powershell
      run: |
        $projectFile = Get-ChildItem -Path "." -Recurse -Filter "cheatengine.lpi" | Select-Object -First 1
        
        if ($projectFile) {
            Write-Host "Found project file: $($projectFile.FullName)"
            
            # Try different approaches
            $success = $false
            
            # Approach 1: Build with specific configuration
            Write-Host "Approach 1: Building with lazbuild..."
            & "C:\lazarus\lazbuild.exe" $projectFile.FullName --os=win64 --cpu=x86_64 --build-mode="Default"
            
            if ($LASTEXITCODE -eq 0) {
                $success = $true
                Write-Host "Build successful with lazbuild"
            }
            
            # Approach 2: Use Makefile if it exists
            if (-not $success) {
                $makefile = Get-ChildItem -Path "." -Recurse -Filter "Makefile" | Select-Object -First 1
                if ($makefile) {
                    Write-Host "Approach 2: Found Makefile at $($makefile.FullName)"
                    Write-Host "Attempting to build with make..."
                    Set-Location $makefile.DirectoryName
                    make
                    if ($LASTEXITCODE -eq 0) {
                        $success = $true
                        Write-Host "Build successful with make"
                    }
                }
            }
            
            # Approach 3: Check for build scripts
            if (-not $success) {
                Write-Host "Approach 3: Looking for build scripts..."
                $buildScripts = Get-ChildItem -Path "." -Recurse -Filter "*.bat" | Where-Object {
                    $_.Name -match "build" -or $_.Name -match "compile"
                }
                
                foreach ($script in $buildScripts) {
                    Write-Host "Found build script: $($script.FullName)"
                    & $script.FullName
                    if ($LASTEXITCODE -eq 0) {
                        $success = $true
                        Write-Host "Build successful with script: $($script.Name)"
                        break
                    }
                }
            }
            
            if (-not $success) {
                Write-Host "All build attempts failed"
                exit 1
            }
        } else {
            Write-Host "No project file found"
            exit 1
        }
    
    - name: Collect Build Output
      shell: powershell
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        
        # Look for executables in various locations
        $searchPatterns = @(
            "*cheatengine*.exe",
            "*CE*.exe",
            "*.exe"
        )
        
        $foundFiles = 0
        
        foreach ($pattern in $searchPatterns) {
            Get-ChildItem -Path "." -Recurse -Filter $pattern | Where-Object {
                $_.DirectoryName -match "bin" -or 
                $_.DirectoryName -match "output" -or
                $_.DirectoryName -match "win64" -or
                $_.DirectoryName -match "release"
            } | ForEach-Object {
                Write-Host "Found executable: $($_.FullName)"
                Copy-Item $_.FullName -Destination "BuildOutput\" -Force
                $foundFiles++
            }
        }
        
        if ($foundFiles -eq 0) {
            Write-Host "Warning: No executables found, checking all .exe files..."
            Get-ChildItem -Path "." -Recurse -Filter "*.exe" | ForEach-Object {
                Write-Host "Found executable: $($_.FullName)"
                Copy-Item $_.FullName -Destination "BuildOutput\" -Force
                $foundFiles++
            }
        }
        
        Write-Host "Total files found: $foundFiles"
        
        if ($foundFiles -gt 0) {
            7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" ".\BuildOutput\*"
        } else {
            Write-Host "No executable files found"
            exit 1
        }
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64-Build
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
        if-no-files-found: error
