name: Build Cheat Engine

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Lazarus and Dependencies
      run: |
        choco install lazarus -y --version=2.2.2 --no-progress
        choco install 7zip -y --no-progress

    - name: Build Cheat Engine (64-bit Release)
      run: |
        $project = Get-ChildItem -Recurse -Filter cheatengine.lpi | Select-Object -First 1
        if ($project) {
          cd $project.DirectoryName
          C:\lazarus\lazbuild.exe cheatengine.lpi --build-mode="Release 64"
        }

    - name: Collect Build Artifacts
      run: |
        mkdir artifacts
        Copy-Item -Recurse -Path *cheatengine*.exe -Destination artifacts\ -ErrorAction SilentlyContinue
        if (!(Test-Path artifacts\*)) {
          Copy-Item -Recurse -Path .\bin\*.exe -Destination artifacts\ -ErrorAction SilentlyContinue
        }

    - name: Create Archive
      run: |
        if (Test-Path artifacts\*.exe) {
          7z a cheatengine-build-${{ github.sha }}.zip .\artifacts\*
        }

    - uses: actions/upload-artifact@v4
      with:
        name: CheatEngine-Build
        path: cheatengine-build-${{ github.sha }}.zip
