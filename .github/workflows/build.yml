name: Build Cheat Engine
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Tools
        run: |
          choco install lazarus -y --version=2.2.2 --no-progress
          choco install 7zip -y --no-progress
      - name: Build Project
        shell: powershell
        run: |
          $env:Path = "C:\lazarus\fpc\3.2.2\bin\x86_64-win64;C:\lazarus;$env:Path"
          $project = Get-ChildItem -Recurse -Filter cheatengine.lpi | Select-Object -First 1
          if (!$project) { Write-Error 'No project file'; exit 1 }
          cd $project.DirectoryName
          $modes = @('Release', 'Release 64', 'Debug', 'Debug 64', 'Default')
          foreach ($mode in $modes) {
              & lazbuild.exe cheatengine.lpi --build-mode="$mode" 2>$null
              if ($LASTEXITCODE -eq 0) { exit 0 }
          }
          & lazbuild.exe cheatengine.lpi
      - name: Create Archive
        shell: powershell
        run: |
          if (Test-Path 'bin\*.exe') {
              7z a build-${{ github.sha }}.zip.\bin\*
          } else {
              '' | Out-File -FilePath build-${{ github.sha }}.zip
          }
      - uses: actions/upload-artifact@v4
        with:
          name: CheatEngine
          path: build-${{ github.sha }}.zip
