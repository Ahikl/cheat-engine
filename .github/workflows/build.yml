name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download and install Lazarus
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-win64.exe/download" -OutFile "lazarus_main.exe"
        Start-Process -FilePath ".\lazarus_main.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
        
        Invoke-WebRequest -Uri "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-cross-i386-win32-win64.exe/download" -OutFile "lazarus_cross.exe"
        Start-Process -FilePath ".\lazarus_cross.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
        
        "C:\lazarus" >> $env:GITHUB_PATH
        "C:\lazarus\fpc\3.2.2\bin\x86_64-win64" >> $env:GITHUB_PATH

    - name: Build project
      shell: powershell
      run: |
        $projectFile = Get-ChildItem -Recurse -Filter "cheatengine.lpi" | Select-Object -First 1
        if ($projectFile) {
            Set-Location $projectFile.DirectoryName
            & "C:\lazarus\lazbuild.exe" "cheatengine.lpi" --build-mode="Release 64"
        } else {
            Write-Error "Project file not found."
            exit 1
        }

    - name: Package output
      shell: powershell
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        Get-ChildItem -Recurse -Filter "*.exe" | Where-Object { $_.DirectoryName -match "bin" } | Copy-Item -Destination "BuildOutput\"
        7z a "CheatEngine.zip" ".\BuildOutput\*"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CheatEngine
        path: CheatEngine.zip
