name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Lazarus and FPC via Chocolatey
      shell: powershell
      run: |
        choco install lazarus -y --no-progress
        
        $FPC_VERSION = "3.2.2"
        $LAZ_ROOT = "C:\lazarus"
        $FPC_PATH = "$LAZ_ROOT\fpc\$FPC_VERSION\bin\x86_64-win64"
        
        "$LAZ_ROOT" >> $env:GITHUB_PATH
        "$FPC_PATH" >> $env:GITHUB_PATH
        
        Write-Host "Lazarus and FPC paths configured."
    
    - name: Build Main Project
      shell: powershell
      run: |
        # Try to find the main Cheat Engine project file
        $projectFile = Get-ChildItem -Path "." -Recurse -Filter "CheatEngine.lpi" | Select-Object -First 1
        
        if (-not $projectFile) {
            Write-Host "CheatEngine.lpi not found, looking for other main project files..."
            $projectFile = Get-ChildItem -Path "." -Recurse -Filter "*.lpi" | Where-Object {
                $_.Name -match "cheatengine" -or 
                $_.Name -match "CE" -or
                $_.DirectoryName -match "Cheat Engine"
            } | Select-Object -First 1
        }
        
        if ($projectFile) {
            Write-Host "Building main project: $($projectFile.FullName)"
            Write-Host "Using build mode: Release 64"
            
            # Try Release 64 build mode first
            & "C:\lazarus\lazbuild.exe" $projectFile.FullName --build-mode="Release 64" --os=win64 --cpu=x86_64
            
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Release 64 build mode failed, trying default build mode..."
                & "C:\lazarus\lazbuild.exe" $projectFile.FullName --os=win64 --cpu=x86_64
            }
        } else {
            Write-Host "No main project file found, building all projects in root directory..."
            Get-ChildItem -Path "." -Filter "*.lpi" | ForEach-Object {
                Write-Host "Building project: $($_.Name)"
                & "C:\lazarus\lazbuild.exe" $_.FullName --os=win64 --cpu=x86_64
            }
        }
    
    - name: Package Artifacts
      shell: powershell
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        
        # Look for executables in common output directories
        $directories = @("bin", "lib", "output", ".")
        
        foreach ($dir in $directories) {
            if (Test-Path $dir) {
                Get-ChildItem -Path $dir -Recurse -Filter "*.exe" | ForEach-Object {
                    Write-Host "Found executable: $($_.FullName)"
                    Copy-Item $_.FullName -Destination "BuildOutput\" -Force
                }
            }
        }
        
        $fileCount = (Get-ChildItem "BuildOutput\" -Filter "*.exe" | Measure-Object).Count
        Write-Host "Found $fileCount executable files"
        
        if ($fileCount -gt 0) {
            7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" ".\BuildOutput\*"
        } else {
            Write-Host "No executable files found"
        }
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64-Build
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
        if-no-files-found: warn
