name: Build Cheat Engine

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:
jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Lazarus
      run: |
        choco install lazarus -y --no-progress
        echo "C:\lazarus" >> $env:GITHUB_PATH
        echo "C:\lazarus\fpc\3.2.2\bin\x86_64-win64" >> $env:GITHUB_PATH

    - name: Build Projects
      run: |
        Get-ChildItem -Recurse -Filter "*.lpi" | ForEach-Object {
            & "C:\lazarus\lazbuild.exe" $_.FullName --build-mode="Release"
        }

    - name: Package Artifacts
      run: |
        New-Item -Path "BuildOutput" -ItemType Directory -Force
        Get-ChildItem -Recurse -Filter "*.exe" | Where-Object {
            $_.DirectoryName -match "bin" -or $_.DirectoryName -match "lib"
        } | ForEach-Object {
            Copy-Item $_.FullName -Destination "BuildOutput\"
        }
        7z a "Cheat-Engine-Win64-${{ github.sha }}.zip" "BuildOutput\*"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cheat-Engine-Win64
        path: Cheat-Engine-Win64-${{ github.sha }}.zip
